name: PR Checks

on:
  pull_request:
    branches: ["main"]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # Validate JavaScript syntax
      - name: Validate extraction script syntax
        run: node --check skills/ask-expert/scripts/extract-code.js

      # Test script help command
      - name: Test extraction script
        run: node skills/ask-expert/scripts/extract-code.js --help

      # Validate plugin.json schema
      - name: Validate plugin.json
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          jq empty .claude-plugin/plugin.json
          echo "✓ plugin.json is valid JSON"

      # Validate marketplace.json schema
      - name: Validate marketplace.json
        run: |
          jq empty .claude-plugin/marketplace.json
          echo "✓ marketplace.json is valid JSON"

      # Check required files exist
      - name: Verify required files
        run: |
          required_files=(
            "README.md"
            "LICENSE"
            "CHANGELOG.md"
            "CONTRIBUTING.md"
            ".claude-plugin/plugin.json"
            ".claude-plugin/marketplace.json"
            "skills/ask-expert/SKILL.md"
            "skills/ask-expert/scripts/extract-code.js"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
            echo "✓ Found $file"
          done
